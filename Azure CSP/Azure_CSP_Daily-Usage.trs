option loglevel = DEBUGX
option embed = YES
#
# Import usage from Azure CSP
#
import "system\extracted\AzureCSP\${dataDate}_csp_usage.csv" source azure alias csp_usage options { 
    filter (["usageStartTime"] =~ /${dataYear}-${dataMonth}-${dataDay}.*/)
}
import "system\extracted\AzureCSP\${dataDate}_csp_customers.csv" source azure alias customers
import "system\extracted\AzureCSP\${dataDate}_csp_subscriptions.csv" source azure alias subscriptions

#
# Import IUR usage from Azure CSP
#

import "system\extracted\AzureCSP\${dataDate}_csp_usage_IUR.csv" source azure alias csp_usageIUR options { 
    filter (["usageStartTime"] =~ /${dataYear}-${dataMonth}-${dataDay}.*/)
}
import "system\extracted\AzureCSP\${dataDate}_csp_subscriptions_IUR.csv" source azure alias subscriptionsIUR

# import rates
import "system\extracted\AzureCSP_rates\csp_rates_per_threshold.csv" source azure alias stack_rates

# obtain subscription names and normalise data
rename column azure.customers.ID to customer_id
rename column azure.customers.Name to customer_name
rename column azure.stack_rates.meter_id to resource_id

# correlate data within datasets
correlate azure.customers.customer_name azure.subscriptions.subscription_id azure.subscriptions.offerId azure.subscriptions.offerName using customer_id
correlate azure.stack_rates.rate using resource_id

default dset azure.csp_usageIUR
correlate azure.subscriptionsIUR.subscription_id azure.subscriptionsIUR.offerId azure.subscriptionsIUR.offerName using customer_id
correlate azure.stack_rates.rate using resource_id

# create columnn customer_name for IUR
create column customer_name value IUR

default dset azure.csp_usage

append azure.csp_usageIUR to azure.csp_usage

capitalize values in columns customer_id subscription_id customer_name resource_name region unit resource_category resource_subcategory
create mergedcolumn service_name separator " " from "resource_name" "resource_category" "resource_subcategory" "region"
create mergedcolumn service_key separator " | " from "resource_id" "resource_name" "resource_category"

# Set dummy values for columns that don't have a value set
option overwrite = NO
set rate to "0"
#set cogs to "0"
set unit to "Unit/Hours"
create column interval value "individually"
set resource_category to "Azure Stack Generic Resources"

# cleanup and final normalisation
delete columns usageStartTime	usageEndTime resourceUri type partNumber orderNumber	objectType location offerId	offerName



# export data for troubleshooting
export azure.csp_usage as "${dataDate}T1_CSP.csv"
finish
#option services = overwrite
services {
 effective_date = 20180801
	service_type = automatic
	description_col = service_name
	category_col = resource_category
	instance_col = resource_id
	usages_col = service_key
	set_rate_using = rate
	#set_cogs_using = cogs
	interval_col  = interval
	unit_label_col = unit 
	consumption_col = quantity
}
