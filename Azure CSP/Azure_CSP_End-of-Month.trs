option loglevel = DEBUGX
# option embed = YES

# Import usage from Azure CSP
import "system\extracted\AzureCSP\csp_usageitems.csv" source azure alias csp_usage options {
    exclude customerBillableAccount usageDate partnerId	partnerName	partnerBillableAccountId domainName invoiceLineItemType mpnId invoiceNumber chargeStartDate chargeEndDate billingProvider subscriptionDescription	billingCycleType orderId
	filter (["usageDate"] =~ /${dataYear}-${dataMonth}-${dataDay}.*/ )
}

# Import Rates
# import "exported\Rates_CSP.csv" source azure alias stack_rates
import "system\extracted\AzureCSP\csp_billingitems.csv" source azure alias stack_rates options {
    exclude detailLineItemId invoiceLineItemType sku mpnId tier2MpnId chargeStartDate chargeEndDate billingProvider
}

# Import ratecard (to get the normalised name for Reource_name, category and subcategory)
# import "system\extracted\AzureCSP_rates\csp_rates_per_threshold.csv" source azure alias ratecard

# Import OneTime Consumption
import "system\extracted\AzureCSP\csp_onetimeitems.csv" source azure alias csp_onetime options { 
    filter (["orderDate"] =~ /${dataYear}-${dataMonth}-${dataDay}.*/)
}

# Import Office Consumption
import "system\extracted\AzureCSP\csp_officeitems.csv" source azure alias csp_office options { 
    filter (["chargeStartDate"] =~ /${dataYear}-${dataMonth}-${dataDay}.*/)
}

# Import Daily Consumption
import "system\extracted\AzureCSP\${dataDate}_csp_usage.csv" source azure alias csp_usageDaily

if (@FILE_EXISTS("system\extracted\AzureCSP\${dataDate}_csp_usage_IUR.csv") ) {
# Import Daily IUR Usage
import "system\extracted\AzureCSP\${dataDate}_csp_usage_IUR.csv" source azure alias csp_usageIUR
}


# Appending IUR Usage to Normal Usage
if (@DSET_EXISTS(azure.csp_usageIUR)) {
append azure.csp_usageIUR to azure.csp_usageDaily
}

# obtain subscription names and normalise data
default dset azure.csp_usage
rename column azure.csp_usage.customerId to customer_id
rename column azure.csp_usage.customerCompanyName to customer_name
rename column azure.csp_usage.resourceName to resource_name
rename column azure.csp_usage.serviceName to resource_category
rename column azure.csp_usage.serviceType to resource_subcategory
rename column azure.csp_usage.consumedQuantity to quantity
rename column azure.csp_usage.resourceGuid to resource_id
rename column azure.csp_usage.subscriptionId to subscription_id
#rename column azure.stack_rates.postTaxEffectiveRate to rate
#rename column azure.stack_rates.overageQuantity to quantityBilling

lowercase values in columns customer_id resource_name resource_category resource_subcategory unit region

# merge columns in order to correlate rates and usage, first we need to make sure both columns have the same format
capitalize values in columns azure.csp_usage.resource_id azure.stack_rates.resourceGuid azure.csp_usage.subscription_id azure.stack_rates.subscriptionId
create mergedcolumn resource_id2 separator " " from azure.csp_usage.resource_id azure.csp_usage.subscription_id
default dset azure.stack_rates

# Calculating aggregated rates (in case of services with tiering)
aggregate notime subscriptionId match resourceGuid match consumedQuantity match chargeStartDate match chargeEndDate match postTaxTotal  sum
calculate column rate as column postTaxTotal / column consumedQuantity
#export azure.stack_rates as "AzureCSP_Invoice/rates.csv"

create mergedcolumn resource_id2 separator " " from azure.stack_rates.resourceGuid azure.stack_rates.subscriptionId
default dset azure.csp_usage

# correlate data within datasets
correlate azure.stack_rates.rate using resource_id2
#correlate azure.stack_rates.quantityBilling using resource_id2

if (!@DSET_EMPTY(azure.csp_onetime)) {
delete columns azure.csp_onetime.partnerId azure.csp_onetime.customerDomainName azure.csp_onetime.customerCountry azure.csp_onetime.orderDate azure.csp_onetime.invoiceNumber azure.csp_onetime.skuId azure.csp_onetime.chargeType azure.csp_onetime.totalForCustomer azure.csp_onetime.subtotal azure.csp_onetime.taxTotal azure.csp_onetime.currency azure.csp_onetime.discountDetails azure.csp_onetime.invoiceLineItemType azure.csp_onetime.billingProvider
rename column azure.csp_onetime.customerId to customer_id
rename column azure.csp_onetime.customerName to customer_name
rename column azure.csp_onetime.resellerMpnId to tier2MpnId
rename column azure.csp_onetime.productName to resource_name
rename column azure.csp_onetime.skuName to resource_subcategory
rename column azure.csp_onetime.unitPrice to rate
create column azure.csp_onetime.subscriptionName value "Reserved Instances"
rename column azure.csp_onetime.productId to "subscription_id"
rename column azure.csp_onetime.availabilityId to "resource_id"
create column azure.csp_onetime.resource_category value "Reserved Instances"
capitalize values in columns azure.csp_onetime.customer_id
append azure.csp_onetime to azure.csp_usage
}

if (!@DSET_EMPTY(azure.csp_office)) {
delete columns azure.csp_office.partnerId azure.csp_office.customerDomainName azure.csp_office.customerCountry azure.csp_office.orderDate azure.csp_office.invoiceNumber azure.csp_office.skuId azure.csp_office.totalForCustomer azure.csp_office.subtotal azure.csp_office.taxTotal azure.csp_office.currency azure.csp_office.discountDetails azure.csp_office.invoiceLineItemType azure.csp_office.billingProvider
rename column azure.csp_office.customerId to customer_id
rename column azure.csp_office.customerName to customer_name
rename column azure.csp_office.offerName to resource_name
rename column azure.csp_office.chargeType to resource_subcategory
rename column azure.csp_office.unitPrice to rate
rename column azure.csp_office.offerId to "subscription_id"
rename column azure.csp_office.durableOfferId to "resource_id"
create column azure.csp_office.resource_category value "O365"
capitalize values in columns azure.csp_office.customer_id
append azure.csp_office to azure.csp_usage
}

# Service creation
lowercase values in columns customer_id resource_id subscription_id customer_name resource_name region unit resource_category resource_subcategory 
create mergedcolumn service_name separator " " from "resource_name" "resource_category" "resource_subcategory" "region"
create mergedcolumn service_key from "resource_id"

# Correlate resourceUri
lowercase values in columns azure.csp_usageDaily.resource_id azure.csp_usageDaily.subscription_id azure.csp_usage.resource_id azure.csp_usage.subscription_id
default dset azure.csp_usageDaily
create mergedcolumn correl_column separator " " from azure.csp_usageDaily.subscription_id azure.csp_usageDaily.resource_id
default dset azure.csp_usage
create mergedcolumn correl_column separator " " from azure.csp_usage.subscription_id azure.csp_usage.resource_id

correlate azure.csp_usageDaily.resourceUri using correl_column

# Extract ResourceGroup and ResourceName
create mergedcolumn instance from resourceUri /.*\/(.*)$/

lowercase values in column instance
split resourceUri using / retaining 5
rename column resourceUri_split1 to resourceGroup
uppercase values in column resourceGroup
uppercase values in column subscriptionName
uppercase values in column customer_name

# Set dummy values for columns that don't have a value set
option overwrite = NO
set rate to "0"
#set cogs to "0"
set unit to "Unit/Hours"
create column interval value "individually"
# set resource_category as resource_categoryOffice
set resource_category to "Azure Generic Resources"
set subscription_id to "One Time Resources"
set instance as resource_name
set instance to "Generic Instance Usage"
uppercase values in columns customer_name
# set instance as resource_nameOffice

#create mergedcolumn Reseller separator " " from tier2MpnId ResellerName
create mergedcolumn Reseller separator " " from tier2MpnId
# End of reseller Name creation

#where (["ResourceGroupOffice"] != "") {
#	set resourceGroup to "Office"
#} 

option overwrite = NO
set resourceGroup to "ResourceGroup not available"

# 10% Increase in the rate
#option overwrite = yes
#calculate column rate as column rate * value 0.1

# cleanup
delete columns resource_id2 tier2MpnId billingCycleType resourceUri amount region orderId	offerId	totalForCustomer location correl_column subscriptionStartDate	subscriptionEndDate	chargeEndDate totalOtherDiscount tax


# export data for troubleshooting
export azure.csp_usage as "AzureCSP_Invoice/${dataDate}_CSP.csv"
finish
#option services = overwrite
services {
 effective_date = 20180801
	service_type = automatic
	description_col = service_name
	category_col = resource_category
	instance_col = instance
	usages_col = service_key
	rate_col = rate
	#cogs_col = cogs
	interval_col  = interval
	unit_label_col = unit 
	consumption_col = quantity
}

