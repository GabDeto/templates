option loglevel = DEBUGX
#option embed = YES
#


# Import whole usage from Azure CSP
import "system\extracted\AzureCSP\csp_usageitems.csv" source azure alias csp_usage options {
    include subscriptionId resourceGuid consumedQuantity
}

# Import Billing Items
import "system\extracted\AzureCSP\csp_billingitems.csv" source azure alias stack_rates options {
    exclude detailLineItemId invoiceLineItemType sku mpnId tier2MpnId chargeStartDate chargeEndDate billingProvider
}

# Aggregating usage lineItems to gather the real consumed quantity
aggregate notime subscriptionId match resourceGuid match consumedQuantity sum

# Correlating to get the postTaxTotal
lowercase values in columns azure.csp_usage.resourceGuid azure.stack_rates.resourceGuid azure.csp_usage.subscriptionId azure.stack_rates.subscriptionId
create mergedcolumn resource_id2 separator " " from azure.csp_usage.resourceGuid azure.csp_usage.subscriptionId
default dset azure.stack_rates
create mergedcolumn resource_id2 separator " " from azure.stack_rates.resourceGuid azure.stack_rates.subscriptionId
default dset azure.csp_usage

correlate azure.stack_rates.postTaxTotal using resource_id2
create column rate
calculate column rate as column postTaxTotal / column consumedQuantity

# export data for troubleshooting
export azure.csp_usage as "Rates_CSP.csv"
